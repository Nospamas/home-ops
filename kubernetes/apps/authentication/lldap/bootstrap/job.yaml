# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/v1.34.1-standalone-strict/job-v1.json
apiVersion: batch/v1
kind: Job
metadata:
  name: lldap-bootstrap
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: lldap-bootstrap
          image: ghcr.io/lldap/lldap:v0.6.2-alpine-rootless

          command:
            - /app/bootstrap.sh

          env:
            - name: LLDAP_URL
              value: "http://lldap.authentication.svc.cluster.local:17170"

            - name: LLDAP_ADMIN_USERNAME
              valueFrom: { secretKeyRef: { name: lldap-bootstrap, key: username } }

            - name: LLDAP_ADMIN_PASSWORD
              valueFrom: { secretKeyRef: { name: lldap-bootstrap, key: password } }

            - name: DO_CLEANUP
              value: "true"

          volumeMounts:
            - mountPath: /bootstrap/user-schemas/user-schema.json
              name: config-map
              readOnly: true
              subPath: user-schema.json
            - mountPath: /bootstrap/user-configs/user-configs.json
              name: config-map
              readOnly: true
              subPath: user-configs.json
            - mountPath: /bootstrap/group-schemas/group-schema.json
              name: config-map
              readOnly: true
              subPath: group-schema.json
            - mountPath: /bootstrap/group-configs/group-configs.json
              name: config-map
              readOnly: true
              subPath: group-configs.json

      volumes:
        - configMap:
            defaultMode: 420
            name: lldap-configmap
          name: config-map
